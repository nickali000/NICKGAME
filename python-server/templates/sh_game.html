<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Hitler - Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1f1f 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 10px;
            color: #e74c3c;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 800;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .room-info {
            text-align: center;
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .role-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .role-card.liberal {
            border-color: #3498db;
            background: linear-gradient(135deg, #2d3d4d 0%, #3d4d5d 100%);
        }

        .role-card.fascist {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #4d2d2d 0%, #5d3d3d 100%);
        }

        .role-card.hitler {
            border-color: #f39c12;
            background: linear-gradient(135deg, #4d3d2d 0%, #5d4d3d 100%);
        }

        .role-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .role-card.liberal .role-title {
            color: #3498db;
        }

        .role-card.fascist .role-title {
            color: #e74c3c;
        }

        .role-card.hitler .role-title {
            color: #f39c12;
        }

        .role-description {
            text-align: center;
            color: #ccc;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .team-section {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
        }

        .team-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #fff;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .team-member {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .member-role {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .member-role.fascist {
            background-color: #e74c3c;
            color: white;
        }

        .member-role.hitler {
            background-color: #f39c12;
            color: white;
        }

        .game-status {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-card {
            background-color: #2d2d2d;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .info-label {
            color: #aaa;
            font-size: 0.7em;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #fff;
            word-break: break-word;
        }

        .president-badge {
            background-color: #f1c40f;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            vertical-align: middle;
            margin-left: 5px;
            display: inline-block;
        }

        .board-container {
            display: flex;
            flex-direction: row;
            /* Side by side on desktop */
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .board-container {
                flex-direction: row;
                /* Keep side by side but smaller */
                gap: 10px;
            }
        }

        .policy-track {
            background-color: #2d2d2d;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .liberal-track {
            border-top: 4px solid #3498db;
        }

        .fascist-track {
            border-top: 4px solid #e74c3c;
        }

        .track-title {
            text-align: center;
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #aaa;
        }

        .liberal-track .track-title {
            color: #3498db;
        }

        .fascist-track .track-title {
            color: #e74c3c;
        }

        .slots-container {
            display: flex;
            flex-direction: column;
            /* Vertical stack */
            gap: 10px;
            width: 100%;
            align-items: center;
        }

        .policy-slot {
            width: 80%;
            /* Wider slots */
            max-width: 150px;
            height: 60px;
            /* Shorter height for vertical stack */
            background-color: rgba(0, 0, 0, 0.2);
            border: 2px dashed #555;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .liberal-track .policy-slot {
            border-color: #2980b9;
        }

        .fascist-track .policy-slot {
            border-color: #c0392b;
        }

        .slot-number {
            font-size: 1.5em;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.1);
        }

        .policy-card {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .liberal-track .policy-card {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: 2px solid #5dade2;
        }

        .fascist-track .policy-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: 2px solid #ec7063;
        }

        .power-icon {
            position: absolute;
            right: 10px;
            font-size: 1.2em;
            opacity: 0.7;
        }

        .action-area {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #f1c40f;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(241, 196, 15, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(241, 196, 15, 0);
            }
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.1s;
            margin: 5px;
            font-weight: 600;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .tracker-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #444;
            display: inline-block;
            margin: 0 3px;
        }

        .tracker-dot.active {
            background-color: #e74c3c;
            box-shadow: 0 0 8px #e74c3c;
        }

        .policy-option {
            display: inline-block;
            width: 90px;
            height: 130px;
            margin: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .policy-option:hover {
            transform: scale(1.05);
        }

        .policy-option.Liberal {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: 3px solid #5dade2;
        }

        .policy-option.Fascist {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: 3px solid #ec7063;
        }

        .you-are-president {
            background-color: #f1c40f;
            color: #000;
            padding: 10px;
            text-align: center;
            font-weight: 800;
            border-radius: 8px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .hitler-zone {
            border-color: #e74c3c !important;
            /* Brighter red */
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            background-color: rgba(231, 76, 60, 0.1);
        }

        .hitler-zone .slot-number {
            color: #e74c3c !important;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .hitler-zone::after {
            content: "‚ò†Ô∏è";
            position: absolute;
            top: -15px;
            right: -10px;
            font-size: 1.2em;
        }

        .liberal-victory {
            border-color: #2ecc71 !important;
            /* Emerald Green/Blue */
            box-shadow: 0 0 20px #2ecc71;
            transform: scale(1.05);
            z-index: 5;
        }

        .liberal-victory::after {
            content: "üïäÔ∏è";
            position: absolute;
            top: -20px;
            right: -10px;
            font-size: 1.5em;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        .fascist-victory {
            border-color: #c0392b !important;
            box-shadow: 0 0 20px #c0392b;
            transform: scale(1.05);
            z-index: 5;
        }

        .fascist-victory::after {
            content: "üëë";
            position: absolute;
            top: -20px;
            right: -10px;
            font-size: 1.5em;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }

        .winner-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .winner-title {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 20px;
            text-align: center;
        }

        .winner-liberal {
            color: #3498db;
        }

        .winner-fascist {
            color: #e74c3c;
        }
    </style>
</head>

<body>
    <div class="container">
        {% if is_admin %}
        <div style="text-align: right; margin-bottom: 10px;">
            <button onclick="adminResetGame()" class="btn"
                style="background-color: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                üè† Admin Home
            </button>
        </div>
        {% endif %}
        <h1>SECRET HITLER</h1>
        <div class="room-info">Room: {{ room_id }}</div>

        {% if winner %}
        <div class="winner-screen">
            <div class="winner-title {% if winner == 'Liberal' %}winner-liberal{% else %}winner-fascist{% endif %}">
                {{ winner }}s Win!
            </div>
            <button class="btn btn-primary" onclick="resetAndGoToLobby()">Back to Lobby</button>
        </div>
        <script>
            function resetAndGoToLobby() {
                fetch('/api/game/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ room_id: '{{ room_id }}' }),
                })
                    .then(response => response.json())
                    .then(data => {
                        window.location.href = '/lobby?room_id={{ room_id }}&user_id={{ player_id }}';
                    });
            }
        </script>
        {% endif %}

        {% if player_id == president %}
        <div class="you-are-president">
            üëë SEI IL PRESIDENTE
        </div>
        {% endif %}

        {% if player_id == chancellor %}
        <div class="you-are-president" style="background-color: #e67e22;">
            üéñÔ∏è SEI IL CANCELLIERE
        </div>
        {% endif %}

        {% set role_class = 'liberal' if role == 'Liberal' else ('fascist' if role == 'Fascist' else 'hitler') %}

        <div id="role-card-container" class="role-card {{ role_class }}" data-role-class="{{ role_class }}">
            <div class="role-title" style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                Il tuo ruolo: <span id="role-text">{{ role }}</span>
                <button onclick="toggleRole()"
                    style="background: none; border: none; font-size: 1.2em; cursor: pointer;"
                    id="role-toggle-icon">üëÅÔ∏è</button>
            </div>

            <div id="role-content">
                {% if role == 'Liberal' %}
                <div class="role-description">
                    Sei un <strong>Liberale</strong>. Il tuo obiettivo √® approvare 5 politiche liberali o eliminare
                    Hitler.
                </div>
                {% elif role == 'Fascist' %}
                <div class="role-description">
                    Sei un <strong>Fascista</strong>. Il tuo obiettivo √® approvare 6 politiche fasciste o eleggere
                    Hitler.
                    Conosci l'identit√† dei tuoi compagni.
                </div>
                {% elif role == 'Hitler' %}
                <div class="role-description">
                    Sei <strong>Hitler</strong>. Il tuo obiettivo √® essere eletto Cancelliere dopo 3 politiche fasciste.
                    {% if team_info.hitler_knows_team %}
                    Conosci i tuoi alleati fascisti.
                    {% else %}
                    NON conosci chi sono i fascisti.
                    {% endif %}
                </div>
                {% endif %}

                {% if team_info.team_members %}
                <div class="team-section">
                    <div class="team-title">üé≠ La tua squadra</div>
                    {% for member in team_info.team_members %}
                    <div class="team-member">
                        <span class="member-name" {% if member.id in dead_players
                            %}style="text-decoration: line-through; color: #777;" {% endif %}>
                            {{ member.nickname }} {% if member.id in dead_players %}üíÄ{% endif %}
                        </span>
                        <span class="member-role {{ member.role.lower() }}">{{ member.role }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Game Status Info -->
        <div class="game-status">
            <div class="info-card">
                <div class="info-label">Phase</div>
                <div class="info-value">{{ phase }}</div>
            </div>
            <div class="info-card">
                <div class="info-label">President</div>
                <div class="info-value">
                    {% for p in players %}
                    {% if p.id == president %} {{ p.nickname }} {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="info-card">
                <div class="info-label">Tracker</div>
                <div class="info-value">
                    <span class="tracker-dot {% if tracker >= 1 %}active{% endif %}"></span>
                    <span class="tracker-dot {% if tracker >= 2 %}active{% endif %}"></span>
                    <span class="tracker-dot {% if tracker >= 3 %}active{% endif %}"></span>
                </div>
            </div>

            <div class="info-card">
                <div class="info-label">Cancelliere</div>
                <div class="info-value">
                    {% if chancellor %}
                    {% for p in players %}
                    {% if p.id == chancellor %} {{ p.nickname }} {% endif %}
                    {% endfor %}
                    {% elif chancellor_candidate %}
                    <span style="color: #f1c40f; font-size: 0.9em;">(Cand.)</span>
                    {% for p in players %}
                    {% if p.id == chancellor_candidate %} {{ p.nickname }} {% endif %}
                    {% endfor %}
                    {% else %}
                    <span style="color: #666;">---</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Action Areas -->

        <!-- Nomination Phase -->
        {% if phase == 'Nomination' and player_id == president %}
        <div class="action-area">
            <h3>Nomina un Cancelliere</h3>
            <p>Scegli un giocatore da nominare come Cancelliere.</p>
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center;">
                {% for p in players %}
                {% if p.id != player_id and p.id not in dead_players %}
                {% set is_term_limited = false %}
                {% if players|length >= 5 %}
                {% if p.id == last_chancellor_id or p.id == last_president_id %}
                {% set is_term_limited = true %}
                {% endif %}
                {% else %}
                {% if p.id == last_chancellor_id %}
                {% set is_term_limited = true %}
                {% endif %}
                {% endif %}

                <button class="btn btn-primary"
                    onclick="sendAction('nominate_chancellor', {candidate_id: '{{ p.id }}'})" {% if is_term_limited
                    %}disabled style="opacity: 0.5; cursor: not-allowed;" title="Term Limited" {% endif %}>
                    {{ p.nickname }} {% if is_term_limited %}(Lim. Mandato){% endif %}
                </button>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Voting Phase -->
        {% if phase == 'Vote' %}
        <div class="action-area">
            <h3>Vota per il Governo</h3>
            <p>Presidente: <strong>{% for p in players %}{% if p.id == president %}{{ p.nickname }}{% endif %}{% endfor
                    %}</strong></p>
            <p>Cancelliere: <strong>{% for p in players %}{% if p.id == chancellor_candidate %}{{ p.nickname }}{% endif
                    %}{% endfor %}</strong></p>

            {% if player_id in dead_players %}
            <div class="alert alert-danger">Sei morto. Non puoi votare. üíÄ</div>
            {% elif votes.get(player_id) %}
            <div class="alert">Hai votato: {{ votes[player_id].upper() }}</div>
            <p>In attesa degli altri giocatori...</p>
            {% else %}
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="sendAction('vote', {vote: 'ja'})">JA!</button>
                <button class="btn btn-danger" onclick="sendAction('vote', {vote: 'nein'})">NEIN!</button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Legislative Phase (President) -->
        {% if phase == 'LegislativePresident' and player_id == president %}
        <div class="action-area">
            <h3>Sessione Legislativa (Presidente)</h3>
            <p>Seleziona 1 politica da <strong>SCARTARE</strong>.</p>
            <p style="font-size: 0.9em; color: #aaa;">Le altre 2 andranno al Cancelliere.</p>
            <div style="margin-top: 15px;">
                {% for policy in visible_policies %}
                <div class="policy-option {{ policy }}"
                    onclick="sendAction('president_discard', {discarded_policy: '{{ policy }}'})">
                    <div style="padding-top: 50px; font-weight: bold; color: white; text-shadow: 0 0 5px black;">{{
                        policy }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Legislative Phase (Chancellor) -->
        {% if phase == 'LegislativeChancellor' and player_id == chancellor %}
        <div class="action-area">
            <h3>Sessione Legislativa (Cancelliere)</h3>
            <p>Seleziona 1 politica da <strong>SCARTARE</strong>.</p>
            <p style="font-size: 0.9em; color: #aaa;">L'altra sar√† APPROVATA.</p>
            <div style="margin-top: 15px;">
                {% for policy in visible_policies %}
                <div class="policy-option {{ policy }}"
                    onclick="sendAction('chancellor_discard', {discarded_policy: '{{ policy }}'})">
                    <div style="padding-top: 50px; font-weight: bold; color: white; text-shadow: 0 0 5px black;">{{
                        policy }}</div>
                </div>
                {% endfor %}
            </div>
            {% if veto_unlocked %}
            <div style="margin-top: 20px; border-top: 1px solid #555; padding-top: 10px;">
                <button class="btn btn-warning" onclick="sendAction('veto_request', {})">Richiedi VETO</button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Veto Request Phase -->
        {% if phase == 'VetoRequest' %}
        <div class="action-area">
            <h3>Richiesta di Veto</h3>
            {% if player_id == president %}
            <p>Il Cancelliere ha proposto un Veto. Accetti di scartare tutte le politiche?</p>
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="sendAction('veto_response', {approved: true})">Accetta
                    Veto</button>
                <button class="btn btn-danger" onclick="sendAction('veto_response', {approved: false})">Rifiuta (Obbliga
                    a legiferare)</button>
            </div>
            {% else %}
            <p>Il Cancelliere ha richiesto un Veto. In attesa della decisione del Presidente...</p>
            {% endif %}
        </div>
        {% endif %}

        <!-- Policy Peek Phase -->
        {% if phase == 'PolicyPeek' and player_id == president %}
        <div class="action-area">
            <h3>Controllo delle Leggi</h3>
            <p>Ecco le prime 3 carte del mazzo (la prima √® a sinistra):</p>
            <div style="margin-top: 15px; display: flex; justify-content: center;">
                {% for policy in peeked_policies %}
                <div class="policy-option {{ policy }}" style="cursor: default;">
                    <div style="padding-top: 50px; font-weight: bold; color: white; text-shadow: 0 0 5px black;">{{
                        policy }}</div>
                </div>
                {% endfor %}
            </div>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="sendAction('policy_peek_done', {})">Ho
                visto</button>
        </div>
        {% endif %}

        <!-- Investigation Phase -->
        {% if phase == 'Investigation' and player_id == president %}
        <div class="action-area">
            <h3>Verifica della Lealt√†</h3>
            {% if investigated_player %}
            <p>Il giocatore <strong>
                    {% for p in players %}
                    {% if p.id == investigated_player.id %}{{ p.nickname }}{% endif %}
                    {% endfor %}
                </strong> appartiene al partito:</p>
            <h2 style="color: {% if investigated_player.party == 'Liberal' %}#3498db{% else %}#e74c3c{% endif %};">
                {{ investigated_player.party }}
            </h2>
            <button class="btn btn-primary" onclick="sendAction('investigation_confirm', {})">Continua</button>
            {% else %}
            <p>Scegli un giocatore di cui investigare la lealt√†:</p>
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center;">
                {% for p in players %}
                {% if p.id != player_id and p.id not in dead_players %}
                <button class="btn btn-primary" onclick="sendAction('investigate_player', {target_id: '{{ p.id }}'})">
                    {{ p.nickname }}
                </button>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Special Election Phase -->
        {% if phase == 'SpecialElection' and player_id == president %}
        <div class="action-area">
            <h3>Elezione Speciale</h3>
            <p>Scegli il prossimo Presidente (l'ordine di turno riprender√† normalmente dopo):</p>
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center;">
                {% for p in players %}
                {% if p.id != player_id and p.id not in dead_players %}
                <button class="btn btn-primary" onclick="sendAction('special_election', {target_id: '{{ p.id }}'})">
                    {{ p.nickname }}
                </button>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Execution Phase -->
        {% if phase == 'Execution' and player_id == president %}
        <div class="action-area">
            <h3>Giustiziare un Giocatore</h3>
            <p style="color: #e74c3c; font-weight: bold;">Scegli un giocatore da eliminare dal gioco:</p>
            <div style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center;">
                {% for p in players %}
                {% if p.id != player_id and p.id not in dead_players %}
                <button class="btn btn-danger"
                    onclick="if(confirm('Sei sicuro di voler eliminare ' + '{{ p.nickname }}' + '?')) sendAction('execution', {target_id: '{{ p.id }}'})">
                    {{ p.nickname }} üî´
                </button>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}


        <div class="board-container">
            <!-- Liberal Board -->
            <div class="policy-track liberal-track">
                <div class="track-title">Liberal Policies</div>
                <div class="slots-container">
                    {% for i in range(1, game_config.lib_win + 1) %}
                    <div
                        class="policy-slot {% if policies.Liberal >= i %}filled{% endif %} {% if i == game_config.lib_win %}liberal-victory{% endif %}">
                        {% if policies.Liberal >= i %}
                        <div class="policy-card"></div>
                        {% else %}
                        <span class="slot-number">{{ i }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Fascist Board -->
            <div class="policy-track fascist-track">
                <div class="track-title">Fascist Policies</div>
                <!-- Dynamic Fascist Track -->
                <div class="slots-container">
                    {% for i in range(1, game_config.fasc_win + 1) %}
                    <div class="policy-slot {% if policies.Fascist >= i %}filled{% endif %} {% if i > game_config.hitler_zone and i < game_config.fasc_win %}hitler-zone{% endif %} {% if i == game_config.fasc_win %}fascist-victory{% endif %}"
                        title="{% if i > game_config.hitler_zone and i < game_config.fasc_win %}Hitler Zone: Se Hitler diventa Cancelliere, i Fascisti vincono!{% endif %}">
                        {% if policies.Fascist >= i %}
                        <div class="policy-card"></div>
                        {% else %}
                        <span class="slot-number">{{ i }}</span>

                        {% set power = game_config.powers.get(i) %}
                        {% if power == 'PolicyPeek' %}
                        <div class="power-icon">üîÆ</div>
                        {% elif power == 'Investigation' %}
                        <div class="power-icon">üîç</div>
                        {% elif power == 'PublicInquest' %}
                        <div class="power-icon">üì¢</div>
                        {% elif power == 'SpecialElection' %}
                        <div class="power-icon">üó≥Ô∏è</div>
                        {% elif power == 'MartialLaw' %}
                        <div class="power-icon">‚öñÔ∏è</div>
                        {% elif power == 'Execution' %}
                        <div class="power-icon">üî´</div>
                        {% elif power == 'Purge' %}
                        <div class="power-icon">‚ò†Ô∏è</div>
                        {% endif %}

                        <!-- Veto unlock indicator -->
                        {% if i == game_config.fasc_win - 1 %}
                        <div class="veto-icon" style="position: absolute; bottom: 2px; right: 2px; font-size: 0.8em;">‚ùå
                        </div>
                        {% endif %}

                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Power UIs -->

        <!-- Public Inquest UI -->
        {% if phase == 'PublicInquest' and role == 'President' %}
        <div class="game-phase-section">
            <h3>üì¢ Inchiesta Pubblica</h3>
            <p>Scegli un giocatore. La sua lealt√† sar√† rivelata a TUTTI.</p>
            {% if public_investigation %}
            <div class="investigation-result">
                <p>Il giocatore <strong>{{ public_investigation.id }}</strong> appartiene al partito:</p>
                <h2 class="{{ public_investigation.party }}">{{ public_investigation.party }}</h2>
                <button class="btn btn-primary" onclick="sendAction('public_inquest_confirm', {})">Conferma e
                    Termina</button>
            </div>
            {% else %}
            <div class="player-grid">
                {% for p in players %}
                {% if p.id != player_id and p.id not in dead_players %}
                <button class="btn btn-secondary" onclick="sendAction('public_inquest', {target_id: '{{ p.id }}'})">
                    Indaga {{ p.nickname }}
                </button>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Public Inquest Result (For everyone else) -->
        {% if public_investigation and role != 'President' %}
        <div class="game-phase-section">
            <h3>üì¢ Risultato Inchiesta Pubblica</h3>
            <p>Il Presidente ha indagato <strong>{{ public_investigation.id }}</strong>.</p>
            <p>Il suo partito √®: <strong class="{{ public_investigation.party }}">{{ public_investigation.party
                    }}</strong></p>
        </div>
        {% endif %}

        <!-- Martial Law UI -->
        {% if phase == 'MartialLaw' and role == 'President' %}
        <div class="game-phase-section">
            <h3>‚öñÔ∏è Legge Marziale</h3>
            <p>Nomina immediatamente il prossimo Presidente E il prossimo Cancelliere.</p>
            <form id="martial-law-form" onsubmit="event.preventDefault(); sendMartialLaw();">
                <label>Prossimo Presidente:</label>
                <select id="ml-president" class="form-control">
                    {% for p in players %}
                    {% if p.id not in dead_players %}
                    <option value="{{ p.id }}">{{ p.nickname }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <br>
                <label>Prossimo Cancelliere:</label>
                <select id="ml-chancellor" class="form-control">
                    {% for p in players %}
                    {% if p.id not in dead_players %}
                    <option value="{{ p.id }}">{{ p.nickname }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <br>
                <button type="submit" class="btn btn-primary">Nomina e Vota</button>
            </form>
            <script>
                function sendMartialLaw() {
                    const pres = document.getElementById('ml-president').value;
                    const chanc = document.getElementById('ml-chancellor').value;
                    if (pres === chanc) {
                        alert("Presidente e Cancelliere devono essere diversi!");
                        return;
                    }
                    sendAction('martial_law', { next_president_id: pres, next_chancellor_id: chanc });
                }
            </script>
        </div>
        {% endif %}

        <!-- Purge UI -->
        {% if phase == 'Purge' and role == 'President' %}
        <div class="game-phase-section">
            <h3>‚ò†Ô∏è Purga (Doppia Esecuzione)</h3>
            <p>Devi eliminare un giocatore. Rimangono da eliminare: <strong>{{ purge_remaining }}</strong></p>
            <div class="player-grid">
                {% for p in players %}
                {% if p.id != player_id and p.id not in dead_players %}
                <button class="btn btn-danger" onclick="sendAction('purge', {target_id: '{{ p.id }}'})">
                    GIUSTIZIA {{ p.nickname }} üî´
                </button>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Vote History / Last Action -->
        {% if vote_results and phase != 'Vote' %}
        <div class="info-card" style="margin-top: 20px;">
            <div class="info-label">Risultati Ultima Votazione</div>
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 10px;">
                {% for result in vote_results %}
                <div
                    style="padding: 5px 10px; background: #444; border-radius: 4px; border-left: 4px solid {% if result.vote == 'ja' %}#2ecc71{% else %}#e74c3c{% endif %}">
                    {{ result.nickname }}: {{ result.vote.upper() }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>

    <script>
        function setRoleVisibility(visible) {
            const content = document.getElementById('role-content');
            const icon = document.getElementById('role-toggle-icon');
            const card = document.getElementById('role-card-container');
            const roleText = document.getElementById('role-text');
            const roleClass = card.getAttribute('data-role-class');

            if (visible) {
                // Show
                content.style.display = 'block';
                icon.textContent = 'üëÅÔ∏è';
                card.classList.add(roleClass);
                roleText.textContent = "{{ role }}"; // Restore original text
                localStorage.setItem('sh_role_visible', 'true');
            } else {
                // Hide
                content.style.display = 'none';
                icon.textContent = 'üôà';
                card.classList.remove(roleClass);
                roleText.textContent = "Nascosto"; // Obfuscate text
                localStorage.setItem('sh_role_visible', 'false');
            }
        }

        function toggleRole() {
            const content = document.getElementById('role-content');
            const isCurrentlyVisible = content.style.display !== 'none';
            setRoleVisibility(!isCurrentlyVisible);
        }

        // Initialize from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const savedVisibility = localStorage.getItem('sh_role_visible');
            // Default is visible if not set (or if explicitly 'true')
            if (savedVisibility === 'false') {
                setRoleVisibility(false);
            } else {
                setRoleVisibility(true);
            }
        });
    </script>

    <script>
        // WebSocket Connection
        const roomId = "{{ room_id }}";
        const userId = "{{ player_id }}";
        const goServerUrl = "{{ go_server_url }}";
        let wsUrl;

        if (goServerUrl && goServerUrl !== "None" && goServerUrl !== "") {
            wsUrl = goServerUrl;
            if (!wsUrl.endsWith("/ws")) {
                wsUrl += "/ws";
            }
        } else {
            // Dynamic fallback: If on localhost or an IP address, use current host.
            // If on the production domain, use the production WS URL.
            const hostname = window.location.hostname;
            if (hostname.includes("onrender.com")) {
                wsUrl = "wss://nickgame-1.onrender.com/ws";
            } else {
                // Localhost, LAN IP, or other dev environment
                // Localhost, LAN IP. Assumes Go server is on 8080.
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                wsUrl = `${wsProtocol}//${window.location.hostname}:8080/ws`;
            }
        }

        wsUrl += "?room_id=" + roomId + "&user_id=" + userId;

        let socket = null;

        function connect() {
            console.log("Connecting to WebSocket:", wsUrl);
            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                console.log("WebSocket Connected");
            };

            socket.onmessage = function (event) {
                console.log("Message received:", event.data);
                const msg = JSON.parse(event.data);

                // If we receive a game_update, reload the page to get new state
                // Or if we receive a redirect
                if (msg.type === 'game_update' || msg.type === 'state_update' || msg.type === 'view_update') {
                    console.log("Game update received, reloading...");
                    window.location.reload();
                }
            };

            socket.onclose = function () {
                console.log("WebSocket Disconnected, retrying...");
                setTimeout(connect, 1000);
            };

            socket.onerror = function (error) {
                console.error("WebSocket Error:", error);
            };
        }

        connect();

        function sendAction(type, data) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert("Connection lost. Please wait or refresh.");
                return;
            }

            const payload = {
                type: 'action',
                room_id: roomId,
                action: {
                    type: type,
                    ...data
                }
            };

            console.log("Sending action:", JSON.stringify(payload));
            socket.send(JSON.stringify(payload));
        }
    </script>
    <div class="info-toggle-container" style="text-align: center; margin-top: 20px; margin-bottom: 20px;">
        <button class="btn btn-secondary" onclick="toggleInfo()">
            <i class="fas fa-info-circle"></i> Regole & Legenda
        </button>
    </div>

    <div id="game-info-container"
        style="display: none; background-color: #2c3e50; padding: 20px; border-radius: 10px; margin-top: 10px; text-align: left;">
        <h3 style="color: #ecf0f1; border-bottom: 1px solid #7f8c8d; padding-bottom: 10px;">Legenda Poteri Presidenziali
        </h3>
        <ul style="list-style: none; padding: 0; color: #bdc3c7;">
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">üîç</span> <strong>Verifica della
                    lealt√†:</strong> Il Presidente controlla la tessera partito di un giocatore.</li>
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">üì¢</span> <strong>Inchiesta
                    Pubblica:</strong> Il Presidente rivela a TUTTI la tessera partito di un giocatore.</li>
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">üîÆ</span> <strong>Controllo delle
                    leggi:</strong> Il Presidente guarda segretamente le prime 3 carte del mazzo.</li>
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">üó≥Ô∏è</span> <strong>Elezione
                    speciale:</strong> Il Presidente sceglie il prossimo candidato Presidente.</li>
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">‚öñÔ∏è</span> <strong>Legge Marziale:</strong>
                Il Presidente nomina SUBITO sia il prossimo Presidente che il Cancelliere. Si vota immediatamente.</li>
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">üî´</span> <strong>Giustiziare un
                    giocatore:</strong> Il Presidente elimina un giocatore dal gioco.</li>
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">‚ò†Ô∏è</span> <strong>Purga:</strong> Il
                Presidente DEVE eliminare DUE giocatori dal gioco.</li>
            <li style="margin-bottom: 10px;"><span style="font-size: 1.2em;">‚ùå</span> <strong>Potere di Veto:</strong>
                Sbloccato passivamente. Se Cancelliere e Presidente concordano, possono scartare entrambe le leggi.</li>
        </ul>

        <h3 style="color: #ecf0f1; border-bottom: 1px solid #7f8c8d; padding-bottom: 10px; margin-top: 20px;">Come si
            gioca</h3>
        <p style="color: #bdc3c7;">
            <strong>Obiettivo Liberali:</strong> Approvare 5 leggi Liberali O uccidere Hitler.<br>
            <strong>Obiettivo Fascisti:</strong> Approvare 6 leggi Fasciste O far eleggere Hitler Cancelliere (dopo la
            3¬∞ legge fascista).
        </p>
        <p style="color: #bdc3c7;">
            Ogni turno c'√® un Presidente e un Cancelliere. Il Presidente pesca 3 leggi, ne scarta 1 e passa le altre 2
            al Cancelliere. Il Cancelliere ne scarta 1 e approva l'ultima.
        </p>
    </div>

    <script>
        // ... existing scripts ...

        function toggleInfo() {
            var container = document.getElementById("game-info-container");
            if (container.style.display === "none") {
                container.style.display = "block";
            } else {
                container.style.display = "none";
            }
        }

        async function adminResetGame() {
            if (!confirm("Sei sicuro? Questo terminer√† la partita per tutti e tornerete alla lobby.")) {
                return;
            }

            try {
                const response = await fetch('/api/game/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ room_id: roomId })
                });

                const data = await response.json();
                if (data.status === 'reset') {
                    // Redirect to lobby
                    window.location.href = `/lobby?room_id=${roomId}&user_id=${userId}`;
                } else {
                    alert("Errore nel reset della partita: " + (data.message || "Unknown error"));
                }
            } catch (error) {
                console.error("Error resetting game:", error);
                alert("Errore di connessione durante il reset.");
            }
        }
    </script>
</body>

</html>