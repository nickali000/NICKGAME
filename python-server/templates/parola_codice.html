<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parolecodice - Modular Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .word-card {
            aspect-ratio: 2/1;
            transition: all 0.2s;
        }

        .word-card.red {
            background: rgba(239, 68, 68, 0.8);
        }

        .word-card.blue {
            background: rgba(59, 130, 246, 0.8);
        }

        .word-card.neutral {
            background: rgba(156, 163, 175, 0.5);
        }

        .word-card.black {
            background: rgba(0, 0, 0, 0.9);
        }

        .word-card.hidden-color {
            background: rgba(100, 116, 139, 0.3);
        }

        .word-card.voted {
            ring: 3px;
            ring-color: yellow;
            transform: scale(1.05);
        }

        .team-red {
            border-color: #ef4444;
        }

        .team-blue {
            border-color: #3b82f6;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

    <div class="max-w-2xl mx-auto space-y-4">

        <!-- Header -->
        <div class="text-center space-y-2">
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-blue-500">
                üÖøÔ∏è Parolecodice
            </h1>
            <div class="flex justify-center gap-4 text-sm">
                <span class="text-red-400 font-bold">üî¥ Rossi: <span id="score-red">{{ game.scores.red }}</span>/{{
                    game.COLOR_DISTRIBUTION.red }}</span>
                <span class="text-blue-400 font-bold">üîµ Blu: <span id="score-blue">{{ game.scores.blue }}</span>/{{
                    game.COLOR_DISTRIBUTION.blue }}</span>
            </div>
        </div>

        <!-- Team Selection Phase -->
        <div id="team-select-panel"
            class="glass-panel rounded-xl p-4 space-y-4 {% if game.state != 'TEAM_SELECT' %}hidden{% endif %}">
            <h2 class="text-lg font-bold text-center">Scegli la tua squadra</h2>

            <div class="grid grid-cols-2 gap-4">
                <!-- Red Team -->
                <div class="p-3 rounded-lg border-2 team-red bg-red-500/10">
                    <h3 class="font-bold text-red-400 text-center mb-2">üî¥ Rossi</h3>
                    <div id="team-red-list" class="space-y-1 text-sm min-h-[60px]">
                        <!-- Populated by JS -->
                    </div>
                    <button id="btn-join-red" onclick="joinTeam('red')"
                        class="w-full mt-2 py-1 bg-red-600 hover:bg-red-500 rounded text-sm font-bold hidden">
                        Unisciti
                    </button>
                    <button id="btn-captain-red" onclick="becomeCaptain()"
                        class="w-full mt-2 py-1 bg-yellow-600 hover:bg-yellow-500 rounded text-sm font-bold hidden">
                        üëë Diventa Capitano
                    </button>
                </div>

                <!-- Blue Team -->
                <div class="p-3 rounded-lg border-2 team-blue bg-blue-500/10">
                    <h3 class="font-bold text-blue-400 text-center mb-2">üîµ Blu</h3>
                    <div id="team-blue-list" class="space-y-1 text-sm min-h-[60px]">
                        <!-- Populated by JS -->
                    </div>
                    <button id="btn-join-blue" onclick="joinTeam('blue')"
                        class="w-full mt-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-sm font-bold hidden">
                        Unisciti
                    </button>
                    <button id="btn-captain-blue" onclick="becomeCaptain()"
                        class="w-full mt-2 py-1 bg-yellow-600 hover:bg-yellow-500 rounded text-sm font-bold hidden">
                        üëë Diventa Capitano
                    </button>
                </div>
            </div>

            {% if is_admin %}
            <button id="btn-start-game" onclick="startPlaying()"
                class="w-full py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-bold">
                ‚ñ∂Ô∏è Inizia Partita
            </button>
            {% else %}
            <p class="text-center text-sm text-slate-400">Attendi che l'admin avvii la partita...</p>
            {% endif %}
        </div>

        <!-- Playing Phase -->
        <div id="playing-panel" class="{% if game.state != 'PLAYING' %}hidden{% endif %}">

            <!-- Current Turn Info -->
            <div class="glass-panel rounded-lg p-3 text-center mb-4">
                <p class="text-sm">Turno:
                    <span id="turn-indicator" class="font-bold"></span>
                </p>
                <div id="clue-display" class="hidden">
                    <p class="text-lg font-bold mt-1">
                        Indizio: "<span id="clue-word"></span>" - <span id="clue-number"></span>
                    </p>
                    <p class="text-xs text-slate-400">Tentativi rimasti: <span id="guesses-remaining"></span></p>
                </div>
            </div>

            <!-- Captain Clue Input -->
            <div id="captain-input"
                class="glass-panel rounded-lg p-4 space-y-3 border-2 border-yellow-500/50 mb-4 hidden">
                <h3 class="font-bold text-yellow-400">üëë Dai un indizio alla tua squadra</h3>
                <div class="flex gap-2">
                    <input type="text" id="clueWord" placeholder="Parola indizio..."
                        class="flex-1 p-2 bg-slate-800 border border-slate-700 rounded text-white">
                    <input type="number" id="clueNumber" min="1" max="9" value="1"
                        class="w-16 p-2 bg-slate-800 border border-slate-700 rounded text-white text-center">
                </div>
                <button onclick="giveClue()" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold">
                    Invia Indizio
                </button>
            </div>

            <!-- Word Grid -->
            <div id="grid-container" class="grid grid-cols-{{ grid_cols }} gap-1">
                <!-- Populated by JS -->
            </div>

            <!-- End Turn Button -->
            <button id="btn-end-turn" onclick="endTurn()"
                class="w-full mt-4 py-2 bg-slate-700 hover:bg-slate-600 rounded font-bold hidden">
                ‚è≠Ô∏è Passa Turno
            </button>
        </div>

        <!-- Game Over -->
        <div id="game-over-panel"
            class="glass-panel rounded-xl p-6 text-center space-y-4 border-2 border-green-500/50 hidden">
            <h2 class="text-2xl font-bold">üèÜ Partita Terminata!</h2>
            <p class="text-xl">Vincono: <span id="winner-name" class="font-bold"></span></p>
            <p id="winner-reason" class="text-slate-300"></p>

            {% if is_admin %}
            <button onclick="restartGame()" class="py-2 px-6 bg-green-600 hover:bg-green-500 rounded-lg font-bold">
                üîÑ Nuova Partita
            </button>
            {% endif %}
        </div>

        <!-- Back to Lobby (Admin Only) -->
        <div class="text-center pt-2">
            {% if is_admin %}
            <button onclick="endGame()" class="text-slate-400 hover:text-white text-sm underline">
                ‚Üê Termina partita e torna alla Lobby
            </button>
            {% else %}
            <p class="text-xs text-slate-500">Solo l'admin pu√≤ terminare la partita</p>
            {% endif %}
        </div>

    </div>

    <script>
        const PLAYER_ID = "{{ player_id }}";
        const ROOM_ID = "{{ game.room_id }}";
        const IS_ADMIN = {{ 'true' if is_admin else 'false' }};

        // Initial State (Jinja rendered) - will be overwritten by first poll
        let currentState = "{{ game.state }}";
        let playerTeam = "{{ player_team }}";
        let isCaptain = {{ 'true' if is_captain else 'false' }};

        // Polling
        setInterval(async () => {
            try {
                const res = await fetch(`/api/game/${ROOM_ID}/status?user_id=${PLAYER_ID}`);
                const data = await res.json();

                // Check for Lobby Reset
                if (data.state === 'LOBBY') {
                    window.location.href = `/lobby?room_id=${ROOM_ID}&user_id=${PLAYER_ID}`;
                    return;
                }

                updateUI(data);
            } catch (e) {
                console.error("Polling error:", e);
            }
        }, 1000);

        function updateUI(data) {
            // Update Globals
            currentState = data.state;

            // Determine my role/team from data
            const myPlayer = data.players.find(p => p.id === PLAYER_ID);
            // Find my team
            if (data.teams.red.includes(PLAYER_ID)) playerTeam = 'red';
            else if (data.teams.blue.includes(PLAYER_ID)) playerTeam = 'blue';
            else playerTeam = null;

            isCaptain = (data.captains.red === PLAYER_ID || data.captains.blue === PLAYER_ID);

            // Update Scores
            document.getElementById('score-red').textContent = data.scores.red;
            document.getElementById('score-blue').textContent = data.scores.blue;

            // Visibility of Panels
            const teamSelectPanel = document.getElementById('team-select-panel');
            const playingPanel = document.getElementById('playing-panel');
            const gameOverPanel = document.getElementById('game-over-panel');

            if (data.state === 'TEAM_SELECT') {
                teamSelectPanel.classList.remove('hidden');
                playingPanel.classList.add('hidden');
                gameOverPanel.classList.add('hidden');
                updateTeamSelect(data);
            } else if (data.state === 'PLAYING') {
                teamSelectPanel.classList.add('hidden');
                playingPanel.classList.remove('hidden');
                gameOverPanel.classList.add('hidden');
                updatePlaying(data);
            } else if (data.state === 'GAME_OVER') {
                teamSelectPanel.classList.add('hidden');
                playingPanel.classList.remove('hidden'); // Keep grid visible
                gameOverPanel.classList.remove('hidden');
                updateGameOver(data);
                updatePlaying(data); // Update grid to show all
            }
        }

        function updateTeamSelect(data) {
            // Update Lists
            updateTeamList('red', data);
            updateTeamList('blue', data);

            // Update Buttons
            const btnJoinRed = document.getElementById('btn-join-red');
            const btnJoinBlue = document.getElementById('btn-join-blue');
            const btnCaptRed = document.getElementById('btn-captain-red');
            const btnCaptBlue = document.getElementById('btn-captain-blue');

            // Join Buttons
            if (playerTeam !== 'red') btnJoinRed.classList.remove('hidden'); else btnJoinRed.classList.add('hidden');
            if (playerTeam !== 'blue') btnJoinBlue.classList.remove('hidden'); else btnJoinBlue.classList.add('hidden');

            // Captain Buttons
            if (playerTeam === 'red' && !data.captains.red) btnCaptRed.classList.remove('hidden'); else btnCaptRed.classList.add('hidden');
            if (playerTeam === 'blue' && !data.captains.blue) btnCaptBlue.classList.remove('hidden'); else btnCaptBlue.classList.add('hidden');
        }

        function updateTeamList(team, data) {
            const list = document.getElementById(`team-${team}-list`);
            list.innerHTML = '';
            data.teams[team].forEach(pid => {
                const p = data.players.find(x => x.id === pid);
                if (p) {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-1';
                    if (data.captains[team] === pid) div.innerHTML += 'üëë ';
                    div.innerHTML += p.nickname;
                    list.appendChild(div);
                }
            });
        }

        function updatePlaying(data) {
            // Turn Info
            const turnInd = document.getElementById('turn-indicator');
            turnInd.textContent = data.current_team === 'red' ? 'Rossi üî¥' : 'Blu üîµ';
            turnInd.className = `font-bold ${data.current_team === 'red' ? 'text-red-400' : 'text-blue-400'}`;

            // Clue Display
            const clueDisplay = document.getElementById('clue-display');
            if (data.current_clue) {
                clueDisplay.classList.remove('hidden');
                document.getElementById('clue-word').textContent = data.current_clue.word;
                document.getElementById('clue-number').textContent = data.current_clue.number;
                document.getElementById('guesses-remaining').textContent = data.guesses_remaining;
            } else {
                clueDisplay.classList.add('hidden');
            }

            // Captain Input Visibility
            const captainInput = document.getElementById('captain-input');
            if (isCaptain && playerTeam === data.current_team && !data.current_clue && data.state === 'PLAYING') {
                captainInput.classList.remove('hidden');
            } else {
                captainInput.classList.add('hidden');
            }

            // End Turn Button Visibility
            const btnEndTurn = document.getElementById('btn-end-turn');
            if (playerTeam === data.current_team && data.current_clue && !isCaptain && data.state === 'PLAYING') {
                btnEndTurn.classList.remove('hidden');
            } else {
                btnEndTurn.classList.add('hidden');
            }

            // Grid
            const gridContainer = document.getElementById('grid-container');
            // Only rebuild if empty or length changed (optimization)
            // Actually, safest is to rebuild or update cards. Let's update.
            if (gridContainer.children.length !== data.grid.length) {
                gridContainer.innerHTML = '';
                data.grid.forEach((cell, i) => {
                    const div = document.createElement('div');
                    div.id = `word-${i}`;
                    div.className = `word-card rounded p-1 text-center flex items-center justify-center cursor-pointer`;
                    div.onclick = () => voteWord(i);

                    const span = document.createElement('span');
                    span.className = 'text-xs font-bold leading-tight';
                    span.textContent = cell.word;
                    div.appendChild(span);
                    gridContainer.appendChild(div);
                });
            }

            // Update Card Styles
            data.grid.forEach((cell, i) => {
                const div = document.getElementById(`word-${i}`);
                // Remove old colors
                div.classList.remove('red', 'blue', 'neutral', 'black', 'hidden-color');

                if (cell.revealed || isCaptain || data.state === 'GAME_OVER') { // Show all colors if revealed, is captain, or game over
                    div.classList.add(cell.color);
                } else {
                    div.classList.add('hidden-color');
                }

                // Hover effect for voting
                if (!cell.revealed && !isCaptain && playerTeam === data.current_team && data.current_clue && data.state === 'PLAYING') {
                    div.classList.add('hover:ring-2', 'hover:ring-white');
                    div.onclick = () => voteWord(i);
                } else {
                    div.classList.remove('hover:ring-2', 'hover:ring-white');
                    div.onclick = null;
                }
            });
        }

        function updateGameOver(data) {
            document.getElementById('winner-name').textContent = data.winner;
            document.getElementById('winner-name').className = `font-bold ${data.winner === 'Red' ? 'text-red-400' : 'text-blue-400'}`;
            document.getElementById('winner-reason').textContent = data.winner_reason;
        }

        // Actions
        async function sendAction(type, data) {
            try {
                const res = await fetch('/api/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room_id: ROOM_ID,
                        user_id: PLAYER_ID,
                        action: { type, ...data }
                    })
                });
                const result = await res.json();
                if (result.status === 'error') alert(result.message);
                // No reload! Polling will update UI.
                // Force immediate update?
                const statusRes = await fetch(`/api/game/${ROOM_ID}/status?user_id=${PLAYER_ID}`);
                const statusData = await statusRes.json();
                updateUI(statusData);
            } catch (e) {
                console.error(e);
            }
        }

        function joinTeam(team) { sendAction('join_team', { team }); }
        function becomeCaptain() { sendAction('become_captain', {}); }
        function startPlaying() { sendAction('start_playing', {}); }
        function endTurn() { sendAction('end_turn', {}); }
        function restartGame() { sendAction('restart_game', {}); }

        function giveClue() {
            const word = document.getElementById('clueWord').value.trim();
            const number = parseInt(document.getElementById('clueNumber').value) || 1;
            if (!word) { alert("Inserisci una parola!"); return; }
            sendAction('give_clue', { word, number });
            // Clear input
            document.getElementById('clueWord').value = '';
            document.getElementById('clueNumber').value = '1';
        }

        function voteWord(index) {
            // Visual feedback immediately
            document.querySelectorAll('.word-card').forEach(c => c.classList.remove('ring-4', 'ring-yellow-400'));
            const card = document.getElementById(`word-${index}`);
            if (card) card.classList.add('ring-4', 'ring-yellow-400');

            sendAction('vote_word', { word_index: index });
        }

        async function endGame() {
            if (!confirm("Sei sicuro di voler terminare la partita per tutti e tornare alla lobby?")) return;
            try {
                const res = await fetch('/api/game/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room_id: ROOM_ID })
                });
                const result = await res.json();
                if (result.status === 'reset') {
                    window.location.href = `/lobby?room_id=${ROOM_ID}&user_id=${PLAYER_ID}`;
                }
            } catch (e) {
                console.error(e);
                alert("Errore durante la terminazione della partita");
            }
        }

    </script>

</body>

</html>